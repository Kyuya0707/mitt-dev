datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// â˜…è¿½åŠ : æ”¯æ‰•ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
enum PaymentStatus {
  PAID
  REFUNDED
}

//
//  Userï¼ˆSupabase Authé€£æºã‚‚è¨±å®¹ï¼‰
//
model User {
  id        String   @id
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())

  // â–¼ å‰¯æ¥­ãƒ»ç¨å‹™ã®åŒæ„æ—¥ï¼ˆnull â†’ æœªåŒæ„ï¼‰
  consentAt DateTime?

  // âœ… è¿½åŠ ï¼šPPåŒæ„
  ppConsentAt      DateTime?
  ppConsentVersion String?

  // Relations
  questions Question[]
  answers   Answer[]
  purchases Purchase[]
  payouts   Payout[]

  readAnswers   AnswerRead[]
  comments      Comment[]
  notifications Notification[]

  answerLikes AnswerLike[]
}

//
//  Categoryï¼ˆã‚«ãƒ†ã‚´ãƒªãƒã‚¹ã‚¿ï¼‰
//
model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())

  questions Question[]
}

//
//  Questionï¼ˆè³ªå•æœ¬ä½“ï¼‰
//
model Question {
  id        String   @id @default(cuid())
  title     String
  content   String
  createdAt DateTime @default(now())

  // user (optional: user can be deleted)
  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  // category
  category   Category @relation(fields: [categoryId], references: [id])
  categoryId String

  // imageUrl ã¯å»ƒæ­¢ â†’ è¤‡æ•°ç”»åƒãƒ†ãƒ¼ãƒ–ãƒ«ã¸
  // attachmentUrl String? â†æ—§ä»•æ§˜ã¯æ®‹ã™ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¸
  // attachmentUrl String?

  // relations
  answers      Answer[]
  images       QuestionImage[] // â†ğŸ†•è¿½åŠ ï¼ˆè¤‡æ•°ç”»åƒå¯¾å¿œï¼‰
  bestAnswerId String?
  isClosed     Boolean         @default(false)

  rewardAmount Int

  purchases Purchase[]

  // â˜…è¿½åŠ : ã“ã®è³ªå•ãŒã€Œæ”¯æ‰•æ¸ˆã¿ã€ã‹ã©ã†ã‹
  isPaid Boolean @default(false)
}

//
//  Answerï¼ˆå›ç­”ï¼‰
//
model Answer {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())

  pitch     String?
  
  question   Question @relation(fields: [questionId], references: [id])
  questionId String

  userId String? @db.Text
  user   User?   @relation(fields: [userId], references: [id])

  likeCount Int @default(0)

  // è¤‡æ•°ç”»åƒ
  images AnswerImage[]

  // æ—¢èª­
  reads AnswerRead[]

  // ã‚³ãƒ¡ãƒ³ãƒˆ
  comments Comment[]

  likes AnswerLike[]

  negotiation Negotiation?
}

model AnswerLike {
  userId    String
  answerId  String
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  answer Answer @relation(fields: [answerId], references: [id])

  @@id([userId, answerId])
}

//
//  QuestionImageï¼ˆè³ªå•ç”»åƒ è¤‡æ•°ï¼‰
//
model QuestionImage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  question   Question @relation(fields: [questionId], references: [id])
  questionId String

  url       String
  sortOrder Int // â† ä¸¦ã³é †
}

//
//  èª²é‡‘ Purchase
//
model Purchase {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  userId String

  question   Question @relation(fields: [questionId], references: [id])
  questionId String

  amount Int

  currency String @default("jpy")

  stripeSessionId String? @unique

  status PaymentStatus @default(PAID) // ğŸ‘ˆ ã“ã“ãŒä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String // e.g. "best", "comment", "answer"
  message   String
  url       String? // é€šçŸ¥ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã«é£›ã¶å…ˆ
  createdAt DateTime  @default(now())
  readAt    DateTime?

  user User @relation(fields: [userId], references: [id])
}

//
//  Payoutï¼ˆå ±é…¬æ”¯æ‰•ã„ï¼‰
//
model Payout {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  userId String

  amount Int
  status String
}

//
//  ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°
//
model EventLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  type      String
  payload   Json
}

model AnswerImage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  answer   Answer @relation(fields: [answerId], references: [id])
  answerId String

  url       String
  sortOrder Int    @default(0)
}

model AnswerRead {
  id       String   @id @default(cuid())
  userId   String
  answerId String
  readAt   DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  answer Answer @relation(fields: [answerId], references: [id])

  @@unique([userId, answerId])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())

  answerId String
  answer   Answer @relation(fields: [answerId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])
}

model Negotiation {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())

  answerId       String   @unique
  proposedAmount Int
  status         NegotiationStatus @default(PENDING)

  answer Answer @relation(fields: [answerId], references: [id])
}

enum NegotiationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

